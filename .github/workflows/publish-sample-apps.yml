name: Publish Sample Apps
on:
  workflow_call:
    inputs:
      source_folder:
        required: true
        description: Source folder containing the artifacts to upload. All subfolders will be searched for .ipa, .apk, and .zip files.
        type: string
    secrets:
      google_cloud_service_account_key:
        required: true
        description: JSON key for Google Cloud service account for Firebase authentication
jobs:
  publish_sample_apps:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    - name: Set up Google Cloud Authentication
      uses: google-github-actions/auth@v2
      with:
        create_credentials_file: true
        credentials_json: ${{ secrets.google_cloud_service_account_key }}
        project_id: ${{ vars.firebase_gcp_project }}
    - name: Set up Ruby
      if: ${{ hashFiles('Gemfile.lock') != '' }}
      uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true
    - name: Restore Sample Apps
      uses: actions/download-artifact@v4
      with:
        name: sample-apps
        path: ${{ inputs.source_folder }}
    - name: Store Sample Apps in GCS
      uses: google-github-actions/upload-cloud-storage@v2
      with:
        destination: ${{ vars.firebase_results_bucket }}/sample-apps/${{ github.repository }}
        glob: '**/!(*.dSYM).[iza][pi][apk]'
        parent: false
        path: ${{ inputs.source_folder }}
        process_gcloudignore: false
    - name: Publish Sample Apps to Firebase
      uses: maierj/fastlane-action@v3.1.0
      with:
        lane: publish_sample_apps
